<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Retaining Wall Checks</title>
	<meta name="description" content="Calculation checks for retaining wall design">
	<meta name="author" content="Anthony Chu">

	<link rel="stylesheet" href="wall_css.css">

	<!--[if lt IE 9]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
</head>

<body>
<script src="jquery.js"></script>

<!-- Javascript check ......................................................... -->
<div id="js">
	Please enable javascript
</div>

<div id="error">
</div>

<script>
function erroroutput(msg)
{
	$("#error").html($("#error").html() + msg + "<br />");
}
</script>

<!-- Input ................................................................ -->

<nav id="input" style="display:none;">

<article id="wall">
	<h2>Wall Construction</h2>
	<pre>Stage 1 of 5</pre>

	<p>Dimensions and construction information of the retaining wall</p>

	<section class="form">

	Stem Height: <input type="text" id="stem_height" value=1000></input>
	Stem Thickness: <input type="text" id="stem_thickness" value=100></input>

	Toe Length: <input type="text" id="toe_length" value=100></input>
	Heel Length: <input type="text" id="heel_length" value=100></input>
	
	Base Thickness: <input type="text" id="base_thickness" value=100></input>

	Shear Key: <select id="shear_key"><option value="no">No</option><option value="yes">Yes</option></select>
	<aside id="shear_key_yes">
	Shear Key Height: <input type="text" id="shear_key_height" value=0></input>
	Shear Key Thickness: <input type="text" id="shear_key_thickness" value=0></input>
	</aside>

	<script>

	$("#shear_key").change(function(){
		if ($("#shear_key").val() == 'yes')
		{
			$("#shear_key_yes")[0].style.display = "block";
		}
		else
		{
			$("#shear_key_yes")[0].style.display = "none";
		}
	});

	</script>

	Front Face Detailing: <select id="front_detailing"><option value="none">None</option><option value="stepped">Stepped</option><option value="inclined">Inclined</option></select>

	<aside id="front_detailing_form_stepped">
		Number of Steps: <input type="text" id="front_steps" value="0"></input>
		Step Depth: <input type="text" id="front_step_depth" value="0"></input>
		Step Run: <input type="text" id="front_step_run" value="0"></input>
	</aside>

	<aside id="front_detailing_form_inclined">
		Chamfer Height: <input type="text" id="front_chamfer_height" value="0"></input>
		Chamfer Width: <input type="text" id="front_chamfer_width" value="0"></input>
	</aside>
	
	<script>

	$("#front_detailing").change(function(){
		$("#front_detailing_form_stepped")[0].style.display = "none";
		$("#front_detailing_form_inclined")[0].style.display = "none";

		if ($("#front_detailing").val() == 'stepped')
		{
			$("#front_detailing_form_stepped")[0].style.display = "block";
		}
		
		if ($("#front_detailing").val() == 'inclined')
		{
			$("#front_detailing_form_inclined")[0].style.display = "block";
		}
	});

	</script>

	Retaining Face Detailing: <select id="back_detailing"><option value="none">None</option><option value="stepped">Stepped</option><option value="inclined">Inclined</option></select>
		
	<aside id="back_detailing_form_stepped">
		Number of Steps: <input type="text" id="back_steps" value="0"></input>
		Step Depth: <input type="text" id="back_step_depth" value="0"></input>
		Step Run: <input type="text" id="back_step_run" value="0"></input>
	</aside>

	<aside id="back_detailing_form_inclined">
		Chamfer Height: <input type="text" id="back_chamfer_height" value="0"></input>
		Chamfer Width: <input type="text" id="back_chamfer_width" value="0"></input>
	</aside>
	
	<script>

	$("#back_detailing").change(function(){
		$("#back_detailing_form_stepped")[0].style.display = "none";
		$("#back_detailing_form_inclined")[0].style.display = "none";

		if ($("#back_detailing").val() == 'stepped')
		{
			$("#back_detailing_form_stepped")[0].style.display = "block";
		}
		if ($("#back_detailing").val() == 'inclined')
		{
			$("#back_detailing_form_inclined")[0].style.display = "block";
		}
	});

	</script>

	</section>

</article>

<article id="retained_soil">
	<h2>Retained Soil</h2>
	<pre>Stage 2 of 5</pre>

	<p>Information on the retained soil which will apply loading conditions on the wall, from the surface top to the bottom of the retaining wall:</p>

	<div class="soil_name">Name</div><div class="soil_depth">Depth</div><div class="soil_weight">UnitWeight</div><div class="soil_angle">Angle</div>
	<section id="soil_form">
	</section>
	<a id="add_retained_layer">Add new layer...</a>

	<script>
	function new_retained_layer()
	{
		$("#soil_form").append('<div class="retained_layer"><input type="text" class="soil_name"></input><input type="text" class="soil_depth" value=0 ></input><input type="text" value=0 class="soil_weight"></input><input type="text" value=0 class="soil_angle"></input><input type="button" class="soil_delete" value="X"></input></div>');
	}

	$("#add_retained_layer").click(function(){new_retained_layer();});

	new_retained_layer();

	$("#soil_form").on('click', '.soil_delete', function(){
		$(this).parent().remove();
	});
	</script>
</article>

<article id="inside_soil">
	<h2>Inside Soil</h2>
	<pre>Stage 3 of 5</pre>

	<p>Information on the soil on the passive side of the wall</p>
</article>

<article id="bearing_soil">
	<h2>Bearing Soil</h2>
	<pre>Stage 4 of 5</pre>

	<p>Information on the bearing soil that the wall will sit on</p>
</article>

<article id="loading">
	<h2>Additional Loading</h2>
	<pre>Stage 5 of 5</pre>

	<p>Additional loads which are applied on the retaining wall</p>
</article>

<!-- Drawing .................................................................. -->

<article id="sketch">

<canvas id="preview" width="500" height="500">Browser doesn't support preview</canvas>
<script>

function draw_rectangle (axes, bottom_x, bottom_y, width, height, colour)
{
	if (axes.context)
	{
		var min_x = Math.floor(axes.o_x + axes.scale * bottom_x);
		var max_y = Math.floor(axes.o_y - axes.scale * bottom_y);
		var max_x = Math.floor(axes.o_x + axes.scale * (bottom_x + width));
		var min_y = Math.floor(axes.o_y - axes.scale * (bottom_y + height));
		context = axes.context;

		context.beginPath();
      	context.rect(min_x, min_y, max_x - min_x, max_y - min_y);
      	context.fillStyle = "#" + colour;
      	context.fill();
     }
}

function draw_triangle(axes, x_1, y_1, width, height, colour)
{
	if (axes.context)
	{
		context = axes.context;
		
		var x_2 = Math.floor(axes.o_x + (x_1 + width) * axes.scale);
		var y_2 = Math.floor(axes.o_y - (y_1 + height) * axes.scale);
		var x_1 = Math.floor(axes.o_x + x_1 * axes.scale);
		var y_1 = Math.floor(axes.o_y - y_1 * axes.scale);

		context.beginPath();
		context.moveTo(x_1, y_1);
		context.lineTo(x_1, y_2);
		context.lineTo(x_2, y_1);
		context.lineTo(x_1, y_1);
		context.closePath();
      	context.fillStyle = "#" + colour;
		context.fill();
	}
}

function draw_clear(context)
{
	$("#error").html('');
	context.clearRect(0, 0, 1000, 1000);
}

function redraw() {

var canvas = $("#preview")[0];
canvas.width=1000;
canvas.height=1000;
canvas.style.width="100%";
canvas.style.height="100%";

var context = canvas.getContext('2d');
var total_height = 0;
var total_width = 0;
draw_clear(context);

var stem_height = parseInt($("#stem_height").val());
var stem_thickness = parseInt($("#stem_thickness").val());
var toe_length = parseInt($("#toe_length").val());
var heel_length = parseInt($("#heel_length").val());
var base_thickness = parseInt($("#base_thickness").val());
var shear_key_height = 0;
var shear_key_thickness = 0;

if ($("#shear_key").val() == 'yes')
{
	shear_key_height = parseInt($("#shear_key_height").val());
	shear_key_thickness = parseInt($("#shear_key_thickness").val());
}

total_height = stem_height + base_thickness + shear_key_height;
total_width = toe_length + heel_length + stem_thickness;

var axes = {scale: 0, o_x: 0, o_y: 0, context: null, left_edge: 0, right_edge: 0};

axes.context = context;

if ((800 / total_height) < (600 / total_width))
{
	axes.scale = 800 / total_height;
	axes.o_y = 900 - axes.scale * shear_key_height;
	axes.o_x = (1000 - axes.scale * total_width) / 2;
	axes.left_edge = -axes.o_x;
	axes.right_edge = axes.o_x;
}
else
{
	axes.scale = 600 / total_width;
	axes.o_x = 200;
	axes.left_edge = -200;
	axes.right_edge = 200;
	axes.o_y = 1000 - (1000 - axes.scale * total_height) / 2;
}

var retaining_wall = '444444';
var surface = stem_height + base_thickness;
var detail_start = 0;
var footing = 0;

// Standard Parts ----------------------------------------------------------------------

draw_rectangle(axes, 0, 0, total_width, base_thickness, retaining_wall);
draw_rectangle(axes, toe_length, base_thickness, stem_thickness, stem_height, retaining_wall);

if ($("#shear_key").val() == 'yes')
{
	if (shear_key_thickness <= total_width)
	{
		draw_rectangle(axes, total_width - shear_key_thickness, -shear_key_height, shear_key_thickness, shear_key_height, retaining_wall);
	}
	else
	{
		$("#shear_key_thickness").removeClass('nonerror').addClass('error');
		erroroutput ('Shear key is too thick');	
	}
	footing = -shear_key_height;
}

// Detailing ----------------------------------------------------------------------------

if ($("#back_detailing").val() == 'stepped')
{
	step_depth = parseInt($("#back_step_depth").val());
	step_run = parseInt($("#back_step_run").val());
	steps = parseInt($("#back_steps").val())

	if ((steps * step_depth) <= stem_height && (step_run * steps) <= heel_length)
	{
		$("#back_step_depth").removeClass('error').addClass('nonerror');
		$("#back_step_run").removeClass('error').addClass('nonerror');
		for (i = 0; i < steps; i++)
		{
			draw_rectangle(axes, toe_length + stem_thickness, base_thickness + i * step_depth, toe_length - (i+1) * step_run, step_depth, retaining_wall);
		}
		detail_start = base_thickness + i * step_depth;
	}
	else
	{
		if ((steps * step_depth) > stem_height)
		{
			$("#back_step_depth").removeClass('nonerror').addClass('error');
			erroroutput ('Retaining face detailing exceeds stem height');
		}

		if ((step_run * steps) > toe_length)
		{
			$("#back_step_run").removeClass('nonerror').addClass('error');
			erroroutput ('Retaining face detailing exceeds toe length');
		}
		detail_start = 0;
	}
}

if ($("#back_detailing").val() == 'inclined')
{
	chamfer_width = parseInt($("#back_chamfer_width").val());
	chamfer_height = parseInt($("#back_chamfer_height").val());

	if (chamfer_height <= stem_height && chamfer_width <= heel_length)
	{
		draw_triangle(axes, toe_length + stem_thickness, base_thickness, chamfer_width, chamfer_height, retaining_wall);
		detail_start = base_thickness + chamfer_height;
	}
	else
	{
		if (chamfer_height > stem_height)
		{
			$("#back_chamfer_height").removeClass('nonerror').addClass('error');
			erroroutput ('Retaining face detailing exceeds stem height');
		}
		if (chamfer_width > toe_length)
		{
			$("#back_chamfer_width").removeClass('nonerror').addClass('error');
			erroroutput ('Retaining face detailing exceeds stem width');
		}
		detail_start = 0;
	}
}

if ($("#front_detailing").val() == 'stepped')
{
	step_depth = parseInt($("#front_step_depth").val());
	step_run = parseInt($("#front_step_run").val());
	if ((steps * step_depth) <= stem_height && (step_run * steps) <= toe_length)
	{
		for (i = 0; i < parseInt($("#front_steps").val()); i++)
		{
			draw_rectangle(axes, step_run * (i+1), base_thickness + i * step_depth, toe_length - step_run * (i+1), step_depth, retaining_wall);
		}
	}
	else
	{
		if ((steps * step_depth) > stem_height)
		{
			$("#front_step_depth").removeClass('nonerror').addClass('error');
			erroroutput ('Front face detailing exceeds stem height');
		}

		if ((step_run * steps) > toe_length)
		{
			$("#front_step_run").removeClass('nonerror').addClass('error');
			erroroutput ('Front face detailing exceeds toe length');
		}
		detail_start = 0;
	}
}

if ($("#front_detailing").val() == 'inclined')
{
	chamfer_width = parseInt($("#front_chamfer_width").val());
	chamfer_height = parseInt($("#front_chamfer_height").val());

	if (chamfer_height <= stem_height && chamfer_width <= toe_length)
	{
		draw_triangle(axes, toe_length, base_thickness, -chamfer_width, chamfer_height, retaining_wall);
	}
	else
	{
		if (chamfer_height > stem_height)
		{
			$("#front_chamfer_height").removeClass('nonerror').addClass('error');
			erroroutput ('Front face detailing exceeds stem height');
		}
		if (chamfer_width > toe_length)
		{
			$("#front_chamfer_width").removeClass('nonerror').addClass('error');
			erroroutput ('Front face detailing exceeds stem width');
		}
	}
	detail_start = 0;
}

// Retaining Soil ------------------------------------------------------------------
var current_depth = surface;
var count = 0;
$('.retained_layer').each(function(i, obj){
	count = count + 1;
	depth = parseInt($(obj).children('.soil_depth').val());
	colour = Math.round(Math.abs(Math.sin(count * 17 * Math.PI / 36)) * 255 * 255 * 220);
	colourHEX = colour.toString(16);

	if (current_depth > detail_start)
	{
		if ((current_depth - depth) >= detail_start)
		{
			// No detailing to worry about
			draw_rectangle(axes, toe_length + stem_thickness, current_depth - depth, axes.right_edge + heel_length, depth, colourHEX);
		}
		else
		{
			// Transition into detailing
		}
	}
	else
	{
		if (current_depth >= footing && (current_depth - depth) >= footing)
		{
			// Fully in detailing area

		}
		else if (current_depth >= footing && (current_depth - depth) < footing)
		{
			// Partially over specified
		}
		else
		{
			// Over specified don't bother
		}
	}

	current_depth = current_depth - depth;
});

}
$(document).on('change', 'input', function(){redraw()});
$("input").change(function(){redraw()});
$("select").change(function(){redraw()});



redraw();

</script>

</article>

</nav>

<!-- Output ................................................................... -->

<nav id="output" style="display:none">
	<h2>Results</h2>
	
</nav>

<script>
	$("#input").show();
	$("#js").hide();
</script>

</body>
</html>